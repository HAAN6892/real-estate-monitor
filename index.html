<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ  ë¶€ë™ì‚° ë§¤ìˆ˜ ëŒ€ì‹œë³´ë“œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06060b;
  --surface: #0d0d14;
  --surface2: #13131e;
  --surface3: #1a1a28;
  --border: #232336;
  --border-hover: #3a3a55;
  --text: #eeeef5;
  --text-dim: #7a7a95;
  --text-mid: #a0a0b8;
  --accent: #7c6af6;
  --accent2: #9d8df7;
  --green: #34d399;
  --green-dim: rgba(52,211,153,0.12);
  --red: #f87171;
  --red-dim: rgba(248,113,113,0.12);
  --yellow: #fbbf24;
  --yellow-dim: rgba(251,191,36,0.12);
  --blue: #60a5fa;
  --blue-dim: rgba(96,165,250,0.12);
  --mono: 'JetBrains Mono', monospace;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans KR',sans-serif; background:var(--bg); color:var(--text); line-height:1.6; }

/* Layout â€” ë‹¨ì¼ ì»¬ëŸ¼ (ì‚¬ì´ë“œë°” ì œê±°) */
.main { max-width:1100px; margin:0 auto; padding:20px 16px; }

/* Header */
.top-bar {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:20px; flex-wrap:wrap; gap:10px;
}
.top-bar-left { display:flex; align-items:center; gap:12px; }
.logo { font-size:20px; font-weight:900; letter-spacing:-0.5px; }
.logo-sub { font-size:11px; color:var(--text-dim); }
.settings-btn {
  background:var(--surface2); border:1px solid var(--border); color:var(--text-mid);
  padding:8px 16px; border-radius:8px; font-size:13px; cursor:pointer;
  font-family:'Noto Sans KR',sans-serif; transition:all 0.2s;
  display:flex; align-items:center; gap:6px;
}
.settings-btn:hover { border-color:var(--accent); color:var(--text); }

/* Settings Panel (overlay) */
.settings-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
  z-index:100; backdrop-filter:blur(4px);
}
.settings-overlay.open { display:flex; justify-content:flex-end; }
.settings-panel {
  background:var(--surface); width:340px; max-width:90vw; height:100vh;
  overflow-y:auto; padding:24px 20px; border-left:1px solid var(--border);
  animation:slideIn 0.25s ease;
}
@keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
.settings-close {
  background:none; border:none; color:var(--text-mid); font-size:20px;
  cursor:pointer; float:right; padding:4px 8px;
}
.settings-close:hover { color:var(--text); }
.settings-title { font-size:18px; font-weight:700; margin-bottom:20px; }

.section-label {
  font-size:10px; font-weight:700; color:var(--text-dim);
  letter-spacing:1.5px; text-transform:uppercase;
  margin:20px 0 10px; padding-bottom:6px;
  border-bottom:1px solid var(--border);
}
.field { margin-bottom:14px; }
.field label { display:block; font-size:12px; color:var(--text-mid); margin-bottom:4px; font-weight:500; }
.field-row { display:flex; align-items:center; gap:8px; }
.field input[type="range"] {
  flex:1; -webkit-appearance:none; height:4px;
  background:var(--border); border-radius:2px; outline:none;
}
.field input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance:none; width:16px; height:16px;
  border-radius:50%; background:var(--accent); cursor:pointer;
  box-shadow:0 0 8px rgba(124,106,246,0.4);
}
.field-value {
  font-family:var(--mono); font-size:14px; font-weight:600;
  width:72px; text-align:right; color:var(--text);
  background:var(--surface2); border:1px solid var(--border);
  border-radius:5px; padding:4px 8px; outline:none;
  -moz-appearance:textfield;
}
.field-value::-webkit-outer-spin-button,
.field-value::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
.field-value:focus { border-color:var(--accent); background:var(--surface3); }
.field-unit { font-size:11px; color:var(--text-dim); }
.field select {
  width:100%; background:var(--surface2); border:1px solid var(--border);
  color:var(--text); padding:8px 12px; border-radius:6px; font-size:13px;
  font-family:'Noto Sans KR',sans-serif; cursor:pointer; outline:none;
}
.field-hint { font-size:10px; color:var(--text-dim); font-weight:400; }

.policy-ref {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; padding:10px 12px; margin-bottom:10px; font-size:11px;
}
.policy-ref-title { font-weight:600; font-size:10px; color:var(--text-mid); margin-bottom:5px; letter-spacing:0.5px; }
.policy-ref-row { display:flex; align-items:center; gap:6px; color:var(--text-dim); padding:1px 0; }
.ref-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }

/* Top Stats */
.stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:24px; }
.stat-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; padding:14px 16px; transition:border-color 0.2s;
}
.stat-card:hover { border-color:var(--border-hover); }
.stat-label { font-size:10px; color:var(--text-dim); font-weight:500; letter-spacing:0.5px; margin-bottom:4px; }
.stat-value { font-family:var(--mono); font-size:22px; font-weight:700; letter-spacing:-1px; }
.stat-sub { font-size:10px; color:var(--text-dim); margin-top:3px; }
.stat-bar { height:3px; border-radius:2px; margin-top:8px; background:var(--border); overflow:hidden; }
.stat-bar-fill { height:100%; border-radius:2px; transition:width 0.4s ease; }

/* Sections */
.section { margin-bottom:28px; }
.section-header {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:12px; flex-wrap:wrap; gap:8px;
}
.section-title { font-size:15px; font-weight:700; display:flex; align-items:center; gap:8px; }
.section-badge { font-size:11px; background:var(--surface3); color:var(--text-dim); padding:2px 10px; border-radius:10px; }

/* Loan Breakdown */
.loan-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.loan-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; padding:16px; position:relative; overflow:hidden;
}
.loan-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.loan-card.ok::before { background:var(--green); }
.loan-card.warn::before { background:var(--yellow); }
.loan-card.danger::before { background:var(--red); }
.loan-label { font-size:11px; color:var(--text-dim); margin-bottom:2px; }
.loan-big { font-family:var(--mono); font-size:24px; font-weight:700; margin-bottom:2px; }
.loan-detail { font-size:11px; color:var(--text-dim); line-height:1.6; }
.loan-detail span { color:var(--text-mid); }

/* Search & Sort Bar */
.table-controls {
  display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; align-items:center;
}
.search-input {
  flex:1; min-width:180px; background:var(--surface2); border:1px solid var(--border);
  color:var(--text); padding:8px 12px; border-radius:8px; font-size:13px;
  font-family:'Noto Sans KR',sans-serif; outline:none;
}
.search-input::placeholder { color:var(--text-dim); }
.search-input:focus { border-color:var(--accent); }
.sort-btn {
  background:var(--surface2); border:1px solid var(--border); color:var(--text-mid);
  padding:7px 12px; border-radius:8px; font-size:12px; cursor:pointer;
  font-family:'Noto Sans KR',sans-serif; white-space:nowrap; transition:all 0.15s;
}
.sort-btn:hover, .sort-btn.active { border-color:var(--accent); color:var(--accent2); }
.filter-select {
  background:var(--surface2); border:1px solid var(--border); color:var(--text-mid);
  padding:7px 10px; border-radius:8px; font-size:12px; cursor:pointer;
  font-family:'Noto Sans KR',sans-serif; outline:none;
}

/* Property Cards (ëª¨ë°”ì¼ ëŒ€ì‘) */
.table-wrap {
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; overflow:hidden;
}
table { width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed; }
thead { background:var(--surface2); }
th { padding:9px 10px; text-align:left; font-weight:500; color:var(--text-dim); font-size:11px; letter-spacing:0.5px; cursor:pointer; white-space:nowrap; }
th:hover { color:var(--text-mid); }
td { padding:10px; border-top:1px solid var(--border); vertical-align:top; }
tr:hover td { background:rgba(124,106,246,0.03); }

/* ì»¬ëŸ¼ ë„ˆë¹„ ì§€ì • */
.col-name { width:22%; }
.col-region { width:10%; }
.col-area { width:7%; }
.col-price { width:12%; }
.col-equity { width:12%; }
.col-loan { width:13%; }
.col-monthly { width:10%; }
.col-verdict { width:8%; }
.col-link { width:6%; }

.mono { font-family:var(--mono); font-weight:600; }
.tag { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:500; }
.tag-ok { background:var(--green-dim); color:var(--green); }
.tag-warn { background:var(--yellow-dim); color:var(--yellow); }
.tag-danger { background:var(--red-dim); color:var(--red); }
.tag-region { background:var(--blue-dim); color:var(--blue); font-size:10px; }

/* Links */
.link-icons { display:flex; gap:4px; }
.link-icon {
  display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; border-radius:6px; font-size:12px;
  text-decoration:none; transition:all 0.15s;
  background:var(--surface3); color:var(--text-mid); border:1px solid var(--border);
}
.link-icon:hover { border-color:var(--accent); color:var(--accent2); transform:scale(1.1); }

/* Condition Chips */
.condition-row { display:flex; flex-wrap:wrap; gap:6px; }
.cond-chip {
  background:var(--surface2); border:1px solid var(--border);
  padding:5px 12px; border-radius:20px; font-size:11px;
  color:var(--text-mid); white-space:nowrap;
}

/* Quick Links */
.quick-links { display:flex; flex-wrap:wrap; gap:8px; }

/* Area Toggle */
.area-toggle { cursor:pointer; user-select:none; }
.area-toggle:hover { color:var(--accent2); }
#areaUnitLabel { font-size:10px; padding:1px 5px; background:var(--accent); color:#fff; border-radius:3px; }
.quick-link {
  display:flex; align-items:center; gap:8px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; padding:10px 14px; text-decoration:none;
  color:var(--text); transition:all 0.2s; flex:1; min-width:140px;
}
.quick-link:hover { border-color:var(--accent); transform:translateY(-1px); }
.ql-icon { font-size:18px; }
.ql-name { font-size:13px; font-weight:600; }
.ql-desc { font-size:10px; color:var(--text-dim); }

/* Policy Timeline */
.timeline { display:flex; flex-direction:column; gap:8px; }
.tl-item {
  background:var(--surface); border:1px solid var(--border);
  border-radius:8px; padding:12px 14px; display:flex; gap:12px;
  align-items:flex-start; transition:border-color 0.2s;
}
.tl-item:hover { border-color:var(--border-hover); }
.tl-dot { width:8px; height:8px; border-radius:50%; margin-top:6px; flex-shrink:0; }
.tl-dot.high { background:var(--red); box-shadow:0 0 6px rgba(248,113,113,0.5); }
.tl-dot.mid { background:var(--yellow); }
.tl-dot.low { background:var(--green); }
.tl-date { font-family:var(--mono); font-size:11px; color:var(--text-dim); min-width:72px; padding-top:1px; }
.tl-body { flex:1; }
.tl-title { font-size:13px; font-weight:600; margin-bottom:2px; }
.tl-impact { font-size:11px; color:var(--text-dim); line-height:1.5; }
.tl-impact em { color:var(--yellow); font-style:normal; }

/* Policy Loan Grid */
.policy-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.policy-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; padding:14px 16px; position:relative; overflow:hidden;
}
.policy-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
.policy-card.eligible::before { background:var(--green); }
.policy-card.ineligible::before { background:var(--red); }
.policy-card.conditional::before { background:var(--yellow); }
.policy-card.checking::before { background:var(--blue); }
.policy-name { font-size:13px; font-weight:700; margin-bottom:2px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.policy-status { font-size:11px; font-weight:600; }
.policy-status.yes { color:var(--green); }
.policy-status.no { color:var(--red); }
.policy-status.maybe { color:var(--yellow); }
.policy-status.check { color:var(--blue); }
.policy-detail { font-size:11px; color:var(--text-dim); margin-top:4px; line-height:1.5; }
.policy-gap { font-family:var(--mono); font-size:10px; margin-top:5px; padding:3px 8px; border-radius:4px; display:inline-block; }
.policy-gap.over { background:var(--red-dim); color:var(--red); }
.policy-gap.close { background:var(--yellow-dim); color:var(--yellow); }
.policy-gap.under { background:var(--green-dim); color:var(--green); }

/* Footer */
.footer { text-align:center; padding:16px; font-size:11px; color:var(--text-dim); border-top:1px solid var(--border); margin-top:20px; }

/* Trade History */
.trade-history {
  grid-column:1/-1; background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; padding:10px 12px; margin-top:4px; display:none;
}
.trade-history.open { display:block; }
.trade-history-title {
  font-size:11px; font-weight:600; color:var(--accent2); margin-bottom:6px;
  display:flex; justify-content:space-between; align-items:center;
}
.trade-row {
  display:flex; gap:12px; padding:4px 0; font-size:11px;
  border-bottom:1px solid var(--border);
}
.trade-row:last-child { border-bottom:none; }
.trade-date { color:var(--text-dim); min-width:70px; }
.trade-price { font-family:var(--mono); font-weight:600; min-width:80px; }
.trade-floor { color:var(--text-mid); }
.trade-delta { font-family:var(--mono); font-size:10px; }
.trade-delta.up { color:var(--red); }
.trade-delta.down { color:var(--green); }
.trade-delta.same { color:var(--text-dim); }
.expand-btn {
  cursor:pointer; color:var(--accent2); font-size:10px;
  background:none; border:none; padding:0; font-family:'Noto Sans KR',sans-serif;
}
.expand-btn:hover { color:var(--accent); }

/* ===== MOBILE ===== */
@media(max-width:768px) {
  .main { padding:12px 10px; }
  .stats-row { grid-template-columns:repeat(2,1fr); gap:8px; }
  .stat-value { font-size:18px; }
  .loan-grid { grid-template-columns:1fr; }
  .loan-big { font-size:20px; }
  .policy-grid { grid-template-columns:1fr; }
  .tl-item { flex-direction:column; gap:4px; }
  .tl-date { min-width:auto; }

  /* ë°”ë¡œê°€ê¸° 2ì—´ */
  .quick-links { gap:6px; }
  .quick-link { min-width:calc(50% - 6px); flex:none; padding:8px 10px; }
  .ql-desc { display:none; }

  /* í…Œì´ë¸” â†’ ì¹´ë“œ ë·° */
  .table-wrap { background:none; border:none; border-radius:0; }
  table, thead, tbody, th, td, tr { display:block; }
  thead { display:none; }
  tr {
    background:var(--surface); border:1px solid var(--border);
    border-radius:10px; padding:14px; margin-bottom:10px;
    display:grid; grid-template-columns:1fr 1fr;
    gap:6px 12px;
  }
  tr:hover td { background:transparent; }
  td { padding:2px 0; border:none; }
  td:nth-child(1) { grid-column:1/-1; font-size:14px; margin-bottom:4px; }
  td:nth-child(9) { grid-column:1/-1; }
  td::before { content:attr(data-label); display:block; font-size:10px; color:var(--text-dim); margin-bottom:1px; }
}
</style>
</head>
<body>

<div class="main" id="main">

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-bar-left">
      <div>
        <div class="logo">ğŸ  ìš°ë¦¬ ì§‘ ì‚¬ê¸°</div>
        <div class="logo-sub" id="dataStatus">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
    </div>
    <button class="settings-btn" onclick="toggleSettings()">âš™ï¸ ì„¤ì •</button>
  </div>

  <!-- Top Stats -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card">
      <div class="stat-label">í•©ì‚° ì—°ì†Œë“</div>
      <div class="stat-value" id="totalIncome">â€”</div>
      <div class="stat-sub" id="totalIncomeSub">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">íˆ¬ì… ê°€ëŠ¥ ìê¸°ìê¸ˆ</div>
      <div class="stat-value" id="equity">â€”</div>
      <div class="stat-sub" id="equitySub">â€”</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ìµœëŒ€ ë§¤ìˆ˜ ê°€ëŠ¥ê°€</div>
      <div class="stat-value" id="maxPrice" style="color:var(--accent)">â€”</div>
      <div class="stat-sub" id="maxPriceSub">â€”</div>
      <div class="stat-bar"><div class="stat-bar-fill" id="maxPriceBar" style="width:0%;background:var(--accent)"></div></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ì›” ìƒí™˜ ì—¬ë ¥</div>
      <div class="stat-value" id="monthlyLeft">â€”</div>
      <div class="stat-sub" id="monthlyLeftSub">â€”</div>
      <div class="stat-bar"><div class="stat-bar-fill" id="monthlyBar" style="width:0%;background:var(--green)"></div></div>
    </div>
  </div>

  <!-- Loan Breakdown -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ¦ ëŒ€ì¶œ í•œë„ ë¶„ì„</div>
      <div class="section-badge" id="loanBadge">ì‹¤ì‹œê°„ ê³„ì‚°</div>
    </div>
    <div class="loan-grid">
      <div class="loan-card" id="ltvCard">
        <div class="loan-label">LTV ê¸°ì¤€ ìµœëŒ€ ëŒ€ì¶œ</div>
        <div class="loan-big" id="ltvMax">â€”</div>
        <div class="loan-detail" id="ltvDetail">â€”</div>
      </div>
      <div class="loan-card" id="dsrCard">
        <div class="loan-label">DSR ê¸°ì¤€ ìµœëŒ€ ëŒ€ì¶œ</div>
        <div class="loan-big" id="dsrMax">â€”</div>
        <div class="loan-detail" id="dsrDetail">â€”</div>
      </div>
      <div class="loan-card" id="monthlyCard">
        <div class="loan-label">ì›” ìƒí™˜ ê¸°ì¤€ ìµœëŒ€ ëŒ€ì¶œ</div>
        <div class="loan-big" id="monthlyMax">â€”</div>
        <div class="loan-detail" id="monthlyDetail">â€”</div>
      </div>
      <div class="loan-card" id="finalCard">
        <div class="loan-label">âœ… ì‹¤ì œ ê°€ëŠ¥ ëŒ€ì¶œ (ìµœì†Ÿê°’)</div>
        <div class="loan-big" id="finalLoan" style="color:var(--accent)">â€”</div>
        <div class="loan-detail" id="finalDetail">â€”</div>
      </div>
    </div>
  </div>

  <!-- ë§¤ë¬¼ ì¡°ê±´ ìš”ì•½ -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ” ë§¤ë¬¼ íƒìƒ‰ ì¡°ê±´</div>
      <div class="section-badge">í˜„ì¬ ë°°ì¹˜ ì„¤ì • ê¸°ì¤€</div>
    </div>
    <div class="condition-row">
      <div class="cond-chip">ğŸ“ 59~84ã¡ (20í‰ëŒ€)</div>
      <div class="cond-chip">ğŸš‡ ì—­ì„¸ê¶Œ ë„ë³´ 15ë¶„ ì´ë‚´</div>
      <div class="cond-chip">ğŸ¢ 200ì„¸ëŒ€ ì´ìƒ</div>
      <div class="cond-chip">ğŸ’° ë§¤ë§¤ê°€ 6ì–µ ì´í•˜</div>
      <div class="cond-chip">ğŸš‹ ì‹ ë¶„ë‹¹ì„  ë¼ì¸</div>
      <div class="cond-chip">ğŸ“ ì„œìš¸ ë™ë‚¨ë¶€ Â· ì„±ë‚¨ Â· ìš©ì¸ Â· ê³¼ì²œ Â· ì•ˆì–‘ Â· í•˜ë‚¨ Â· ê´‘ì£¼</div>
    </div>
  </div>

  <!-- ìœ ìš©í•œ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸° -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ”— ë¶€ë™ì‚° ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°</div>
    </div>
    <div class="quick-links">
      <a href="https://new.land.naver.com/" target="_blank" class="quick-link">
        <span class="ql-icon">ğŸŸ¢</span>
        <span class="ql-name">ë„¤ì´ë²„ ë¶€ë™ì‚°</span>
        <span class="ql-desc">ë§¤ë¬¼ ê²€ìƒ‰ Â· ì‹œì„¸</span>
      </a>
      <a href="https://hogangnono.com/" target="_blank" class="quick-link">
        <span class="ql-icon">ğŸŸ¡</span>
        <span class="ql-name">í˜¸ê°±ë…¸ë…¸</span>
        <span class="ql-desc">ì‹¤ê±°ë˜ê°€ Â· ë¦¬ë·°</span>
      </a>
      <a href="https://asil.kr/" target="_blank" class="quick-link">
        <span class="ql-icon">ğŸ”µ</span>
        <span class="ql-name">ì•„ì‹¤</span>
        <span class="ql-desc">ì‹¤ê±°ë˜ê°€ Â· ì‹œì„¸ë¹„êµ</span>
      </a>
      <a href="https://kbland.kr/" target="_blank" class="quick-link">
        <span class="ql-icon">ğŸŸ </span>
        <span class="ql-name">KBë¶€ë™ì‚°</span>
        <span class="ql-desc">KBì‹œì„¸ Â· ëŒ€ì¶œ</span>
      </a>
      <a href="https://rt.molit.go.kr/" target="_blank" class="quick-link">
        <span class="ql-icon">ğŸ›ï¸</span>
        <span class="ql-name">êµ­í† ë¶€ ì‹¤ê±°ë˜ê°€</span>
        <span class="ql-desc">ê³µì‹ ê±°ë˜ ë°ì´í„°</span>
      </a>
    </div>
  </div>

  <!-- Property Table -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ˜ï¸ ê´€ì‹¬ ë§¤ë¬¼ ì‹œë®¬ë ˆì´ì…˜</div>
      <div class="section-badge" id="propertyBadge">ë°ì´í„° ì—†ìŒ</div>
    </div>
    <div class="table-controls">
      <input type="text" class="search-input" id="searchInput" placeholder="ë‹¨ì§€ëª…, ì§€ì—­, ë™ ê²€ìƒ‰...">
      <select class="filter-select" id="regionFilter">
        <option value="">ì „ì²´ ì§€ì—­</option>
      </select>
      <select class="filter-select" id="verdictFilter">
        <option value="">ì „ì²´ íŒì •</option>
        <option value="ë§¤ìˆ˜ê°€ëŠ¥">ë§¤ìˆ˜ê°€ëŠ¥</option>
        <option value="ë¹ ë“¯í•¨">ë¹ ë“¯í•¨</option>
        <option value="ìƒí™˜ì´ˆê³¼">ìƒí™˜ì´ˆê³¼</option>
        <option value="ìê¸ˆë¶€ì¡±">ìê¸ˆë¶€ì¡±</option>
      </select>
      <button class="sort-btn active" data-sort="price-asc" onclick="setSort(this)">ê°€ê²©â†‘</button>
      <button class="sort-btn" data-sort="price-desc" onclick="setSort(this)">ê°€ê²©â†“</button>
      <button class="sort-btn" data-sort="walk" onclick="setSort(this)">ì—­ì„¸ê¶Œìˆœ</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="col-name">ë‹¨ì§€ëª…</th>
            <th class="col-region">ì§€ì—­</th>
            <th class="col-area"><span class="area-toggle" onclick="toggleAreaUnit()" title="í´ë¦­í•˜ì—¬ ì „í™˜">ë©´ì  <span id="areaUnitLabel">í‰</span></span></th>
            <th class="col-price">ë§¤ë§¤ê°€</th>
            <th class="col-equity">í•„ìš”ìê¸ˆ</th>
            <th class="col-loan">ëŒ€ì¶œì•¡</th>
            <th class="col-monthly">ì›”ìƒí™˜</th>
            <th class="col-verdict">íŒì •</th>
            <th class="col-link">ë§í¬</th>
          </tr>
        </thead>
        <tbody id="propertyBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Policy Timeline -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ“œ ìµœê·¼ ì •ì±… ë³€ë™</div>
      <div class="section-badge">ì˜í–¥ë„ ë¶„ì„</div>
    </div>
    <div class="timeline">
      <div class="tl-item">
        <div class="tl-dot high"></div>
        <div class="tl-date">2025.10.15</div>
        <div class="tl-body">
          <div class="tl-title">10.15 ì£¼íƒì‹œì¥ ì•ˆì •í™” ëŒ€ì±…</div>
          <div class="tl-impact">ì„œìš¸ ì „ì—­ + ê²½ê¸° 12ê³³ ê·œì œì§€ì—­ ì§€ì •<br><em>â†’ ì„±ë‚¨Â·ì•ˆì–‘ LTV 40~50%, ìš©ì¸ ìˆ˜ì§€Â·ê²½ê¸° ê´‘ì£¼ëŠ” ë¹„ê·œì œ ìœ ì§€ (70%)</em></div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-dot high"></div>
        <div class="tl-date">2025.06.27</div>
        <div class="tl-body">
          <div class="tl-title">6.27 ê°€ê³„ë¶€ì±„ ê´€ë¦¬ ê°•í™”</div>
          <div class="tl-impact">ìˆ˜ë„ê¶Œ ì£¼ë‹´ëŒ€ í•œë„ 6ì–µ ì œí•œ, ìƒì• ìµœì´ˆ LTV 80%â†’70%<br><em>â†’ ìê¸°ìê¸ˆ ë¹„ì¤‘ ìƒìŠ¹, ë§¤ìˆ˜ê°€ëŠ¥ ê°€ê²©ëŒ€ í•˜í–¥ ì••ë°•</em></div>
        </div>
      </div>
      <div class="tl-item">
        <div class="tl-dot mid"></div>
        <div class="tl-date">2025.11</div>
        <div class="tl-body">
          <div class="tl-title">ê¸°ì¤€ê¸ˆë¦¬ ì¸í•˜ 3.0% â†’ 2.75%</div>
          <div class="tl-impact"><em>â†’ ì›” ìƒí™˜ ë¶€ë‹´ ì†Œí­ ê²½ê°, 3.5ì–µ ê¸°ì¤€ ì›” ~8ë§Œì› ì ˆê°</em></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Policy Loan Eligibility -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ¯ ì •ì±…ëŒ€ì¶œ ìê²© ì²´í¬</div>
      <div class="section-badge" id="policyBadge">ì†Œë“ ì—°ë™ ìë™ íŒì •</div>
    </div>
    <div class="policy-grid" id="policyGrid"></div>
  </div>

  <div class="footer">
    ì„¤ì •(âš™ï¸)ì—ì„œ ì†Œë“Â·ìê¸ˆÂ·ëŒ€ì¶œ ì¡°ê±´ì„ ë³€ê²½í•˜ë©´ ëª¨ë“  ìˆ«ìê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¬ê³„ì‚°ë©ë‹ˆë‹¤
  </div>
</div>

<!-- ===== Settings Overlay ===== -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
  <div class="settings-panel" onclick="event.stopPropagation()">
    <button class="settings-close" onclick="toggleSettings()">âœ•</button>
    <div class="settings-title">âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</div>

    <div class="section-label">ğŸ‘« ê°€êµ¬ ì†Œë“</div>
    <div class="field">
      <label>ë³¸ì¸ ì—°ì†Œë“</label>
      <div class="field-row">
        <input type="range" id="income1" min="2000" max="10000" step="100" value="4740">
        <input type="number" class="field-value" id="income1Val" value="4740" min="0" max="99999">
        <span class="field-unit">ë§Œì›</span>
      </div>
    </div>
    <div class="field">
      <label>ë°°ìš°ì ì—°ì†Œë“</label>
      <div class="field-row">
        <input type="range" id="income2" min="2000" max="10000" step="100" value="4000">
        <input type="number" class="field-value" id="income2Val" value="4000" min="0" max="99999">
        <span class="field-unit">ë§Œì›</span>
      </div>
    </div>

    <div class="section-label">ğŸ’° ìê¸ˆ í˜„í™©</div>
    <div class="field">
      <label>ì´ ê°€ìš© ìê¸ˆ</label>
      <div class="field-row">
        <input type="range" id="cash" min="3000" max="30000" step="500" value="15000">
        <input type="number" class="field-value" id="cashVal" value="15000" min="0" max="999999">
        <span class="field-unit">ë§Œì›</span>
      </div>
    </div>
    <div class="field">
      <label>ì¸í…Œë¦¬ì–´ ì˜ˆì‚°</label>
      <div class="field-row">
        <input type="range" id="interior" min="0" max="15000" step="500" value="5000">
        <input type="number" class="field-value" id="interiorVal" value="5000" min="0" max="999999">
        <span class="field-unit">ë§Œì›</span>
      </div>
    </div>

    <div class="section-label">ğŸ¦ ëŒ€ì¶œ ì¡°ê±´</div>
    <div class="field">
      <label>ì˜ˆìƒ ê¸ˆë¦¬</label>
      <div class="field-row">
        <input type="range" id="rate" min="2.0" max="6.0" step="0.1" value="4.0">
        <input type="number" class="field-value" id="rateVal" value="4.0" min="0" max="20" step="0.1">
        <span class="field-unit">%</span>
      </div>
    </div>
    <div class="field">
      <label>ëŒ€ì¶œ ë§Œê¸°</label>
      <div class="field-row">
        <input type="range" id="term" min="10" max="40" step="5" value="30">
        <input type="number" class="field-value" id="termVal" value="30" min="1" max="50">
        <span class="field-unit">ë…„</span>
      </div>
    </div>
    <div class="field">
      <label>ì›” ìƒí™˜ í•œë„ (ê´€ë¦¬ë¹„ í¬í•¨)</label>
      <div class="field-row">
        <input type="range" id="monthlyLimit" min="100" max="400" step="10" value="200">
        <input type="number" class="field-value" id="monthlyLimitVal" value="200" min="0" max="9999">
        <span class="field-unit">ë§Œì›</span>
      </div>
    </div>
    <div class="field">
      <label>ê´€ë¦¬ë¹„ ì˜ˆìƒ</label>
      <div class="field-row">
        <input type="range" id="mgmt" min="10" max="60" step="5" value="35">
        <input type="number" class="field-value" id="mgmtVal" value="35" min="0" max="999">
        <span class="field-unit">ë§Œì›</span>
      </div>
    </div>

    <div class="section-label">ğŸ“ ê·œì œ ì„¤ì • <span style="font-size:9px;color:var(--accent);letter-spacing:0">â† ì •ë¶€ ì •ì±…</span></div>
    <div class="policy-ref">
      <div class="policy-ref-title">í˜„í–‰ LTV ê¸°ì¤€</div>
      <div class="policy-ref-row"><span class="ref-dot" style="background:var(--green)"></span> ë¹„ê·œì œ: 70%</div>
      <div class="policy-ref-row"><span class="ref-dot" style="background:var(--yellow)"></span> ì¡°ì •ëŒ€ìƒ: 50%</div>
      <div class="policy-ref-row"><span class="ref-dot" style="background:var(--red)"></span> íˆ¬ê¸°ê³¼ì—´: 40%</div>
      <div class="policy-ref-row"><span class="ref-dot" style="background:var(--blue)"></span> ìƒì• ìµœì´ˆ: 80% (íŠ¹ë¡€)</div>
    </div>
    <div class="field">
      <label>ì ìš© LTV <span class="field-hint">ì‹œë®¬ë ˆì´ì…˜ìš©</span></label>
      <div class="field-row">
        <input type="range" id="ltv" min="0" max="80" step="5" value="70">
        <input type="number" class="field-value" id="ltvVal" value="70" min="0" max="100">
        <span class="field-unit">%</span>
      </div>
    </div>
    <div class="policy-ref" style="margin-top:10px">
      <div class="policy-ref-title">í˜„í–‰ DSR ê¸°ì¤€</div>
      <div class="policy-ref-row"><span class="ref-dot" style="background:var(--text-mid)"></span> ì „ ê¸ˆìœµê¶Œ: 40%</div>
    </div>
    <div class="field">
      <label>ì ìš© DSR <span class="field-hint">ì‹œë®¬ë ˆì´ì…˜ìš©</span></label>
      <div class="field-row">
        <input type="range" id="dsr" min="20" max="60" step="5" value="40">
        <input type="number" class="field-value" id="dsrVal" value="40" min="0" max="100">
        <span class="field-unit">%</span>
      </div>
    </div>

    <div class="section-label">ğŸ˜ï¸ ì£¼íƒ ìƒíƒœ</div>
    <div class="field">
      <label>í˜„ì¬ ì£¼íƒ ìˆ˜</label>
      <select id="houseCount">
        <option value="0">ë¬´ì£¼íƒ</option>
        <option value="1" selected>1ì£¼íƒ (ëŒ€êµ¬)</option>
        <option value="2">2ì£¼íƒ ì´ìƒ</option>
      </select>
    </div>
  </div>
</div>

<script>
// ============================================================
// Settings Panel
// ============================================================
function toggleSettings() {
  document.getElementById('settingsOverlay').classList.toggle('open');
}
function closeSettingsOutside(e) {
  if (e.target === document.getElementById('settingsOverlay')) toggleSettings();
}

// ============================================================
// ë§¤ë¬¼ ë°ì´í„° â€” data.jsonì—ì„œ ë¡œë”©
// ============================================================
let PROPERTIES = [];
let DATA_LOADED = false;
let DATA_UPDATED_AT = '';
let currentSort = 'price-asc';
let searchQuery = '';
let regionFilterVal = '';
let verdictFilterVal = '';
let areaUnit = 'py'; // 'py' or 'm2'

function toggleAreaUnit() {
  areaUnit = areaUnit === 'py' ? 'm2' : 'py';
  document.getElementById('areaUnitLabel').textContent = areaUnit === 'py' ? 'í‰' : 'ã¡';
  update();
}
function fmtArea(p) {
  if (areaUnit === 'py') return p.area_py ? p.area_py + 'í‰' : p.area;
  return p.area;
}
function toggleHistory(btn) {
  const hist = btn.nextElementSibling;
  if (hist && hist.classList.contains('trade-history')) {
    hist.classList.toggle('open');
    btn.textContent = hist.classList.contains('open')
      ? 'â–¼ ê±°ë˜ë‚´ì—­ ì ‘ê¸°'
      : `â–¶ ê±°ë˜ë‚´ì—­ ${hist.querySelectorAll('.trade-row').length}ê±´`;
  }
}

// settings.jsonì—ì„œ ê¸°ë³¸ê°’ ë¡œë“œ
async function loadSettings() {
  try {
    const resp = await fetch('settings.json');
    if (!resp.ok) throw new Error('settings.json ì—†ìŒ');
    const s = await resp.json();
    const fields = ['income1','income2','cash','interior','rate','term','monthlyLimit','mgmt','ltv','dsr'];
    fields.forEach(id => {
      if (s[id] !== undefined) {
        const slider = document.getElementById(id);
        const input = document.getElementById(id + 'Val');
        if (slider) slider.value = s[id];
        if (input) input.value = s[id];
      }
    });
    if (s.houseCount !== undefined) {
      document.getElementById('houseCount').value = s.houseCount;
    }
    console.log('âœ… settings.json ë¡œë”© ì™„ë£Œ');
  } catch (e) {
    console.warn('âš ï¸ settings.json ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
  }
}

function groupProperties(rawItems) {
  const groups = {};
  rawItems.forEach(item => {
    const key = `${item.region}_${item.name}_${item.area_m2}`;
    if (!groups[key]) {
      groups[key] = {
        name: item.name, region: item.region,
        area: Math.round(item.area_m2) + 'ã¡', area_py: item.area_py,
        regulated: item.regulated || false,
        station: item.walk_min ? `ë„ë³´ ${item.walk_min}ë¶„` : 'ì—­ì •ë³´ ì—†ìŒ',
        station_name: item.station || '', line: item.line || '',
        walk_min: item.walk_min, dong: item.dong || '',
        built_year: item.built_year || 0, households: item.households || 0,
        link: item.link || '', prices: [], floors: [], dates: [],
        trades: [],
      };
    }
    groups[key].prices.push(item.price);
    groups[key].floors.push(item.floor);
    groups[key].dates.push(item.trade_date);
    groups[key].trades.push({ price: item.price, floor: item.floor, date: item.trade_date });
  });

  return Object.values(groups).map(g => {
    const avgPrice = Math.round(g.prices.reduce((a,b) => a+b, 0) / g.prices.length);
    const trades = g.trades.sort((a,b) => (b.date||'').localeCompare(a.date||''));
    return {
      name: g.name, region: g.region, area: g.area, area_py: g.area_py, price: avgPrice,
      regulated: g.regulated, station: g.station, station_name: g.station_name,
      line: g.line, walk_min: g.walk_min, dong: g.dong,
      built_year: g.built_year, households: g.households, link: g.link,
      trade_count: g.prices.length,
      min_price: Math.min(...g.prices), max_price: Math.max(...g.prices),
      latest_date: g.dates.sort().reverse()[0] || '',
      price_per_py: g.area_py > 0 ? Math.round(avgPrice / g.area_py) : 0,
      trades: trades,
    };
  }).sort((a,b) => a.price - b.price);
}

async function loadData() {
  try {
    const resp = await fetch('data.json');
    if (!resp.ok) throw new Error('data.json ì—†ìŒ');
    const data = await resp.json();
    DATA_UPDATED_AT = data.updated_at || '';
    PROPERTIES = groupProperties(data.properties || []);
    DATA_LOADED = true;
    // ì§€ì—­ í•„í„° ì˜µì…˜ ìƒì„±
    const regions = [...new Set(PROPERTIES.map(p => p.region))].sort();
    const sel = document.getElementById('regionFilter');
    regions.forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; sel.appendChild(o); });
  } catch (e) {
    PROPERTIES = [];
    DATA_LOADED = false;
  }
  update();
}

// Sort
function setSort(btn) {
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentSort = btn.dataset.sort;
  update();
}

// ============================================================
// ê³„ì‚° í•¨ìˆ˜
// ============================================================
function getVal(id) {
  const input = document.getElementById(id + 'Val');
  if (input && input.value !== '') return parseFloat(input.value);
  return parseFloat(document.getElementById(id).value);
}
function fmtShort(n) {
  if (n >= 10000) { const uk = Math.floor(n/10000); const man = n%10000; return man===0 ? uk+'ì–µ' : uk+'ì–µ '+man.toLocaleString()+'ë§Œ'; }
  return n.toLocaleString() + 'ë§Œ';
}
function monthlyPayment(principal, annualRate, years) {
  if (principal <= 0) return 0;
  const r = annualRate/100/12, n = years*12;
  if (r === 0) return principal/n;
  return principal * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1);
}
function maxLoanFromMonthly(monthlyMax, annualRate, years) {
  const r = annualRate/100/12, n = years*12;
  if (r === 0) return monthlyMax * n;
  return monthlyMax * (Math.pow(1+r,n)-1) / (r * Math.pow(1+r,n));
}

// ============================================================
// ë§í¬ ìƒì„±
// ============================================================
function makeLinks(p) {
  const q = encodeURIComponent(`${p.dong} ${p.name}`);
  const naverUrl = `https://m.land.naver.com/search/result/${q}`;
  const kbUrl = `https://kbland.kr/map?xy=37.5,127.0&search=${encodeURIComponent(p.name)}`;
  let html = `<a href="${naverUrl}" target="_blank" class="link-icon" title="ë„¤ì´ë²„ ë¶€ë™ì‚°">N</a>`;
  html += `<a href="${kbUrl}" target="_blank" class="link-icon" title="KBë¶€ë™ì‚°">K</a>`;
  return html;
}

// ============================================================
// ë©”ì¸ ì—…ë°ì´íŠ¸
// ============================================================
function update() {
  const income1 = getVal('income1'), income2 = getVal('income2');
  const totalIncome = income1 + income2;
  const cash = getVal('cash'), interior = getVal('interior');
  const equity = Math.max(0, cash - interior);
  const rate = getVal('rate'), term = getVal('term');
  const monthlyLimit = getVal('monthlyLimit'), mgmt = getVal('mgmt');
  const ltvPct = getVal('ltv'), dsrPct = getVal('dsr');
  const houseCount = parseInt(document.getElementById('houseCount').value);
  const monthlyRoom = monthlyLimit - mgmt;

  const annualRepayMax = totalIncome * dsrPct / 100;
  const monthlyRepayFromDSR = annualRepayMax / 12;
  const dsrLoanMax = Math.floor(maxLoanFromMonthly(monthlyRepayFromDSR, rate, term));
  const monthlyLoanMax = Math.floor(maxLoanFromMonthly(monthlyRoom, rate, term));

  let ltvLoanMax, effectiveLTV = ltvPct;
  if (houseCount >= 2) { effectiveLTV = 0; ltvLoanMax = 0; }
  else if (ltvPct >= 100 || ltvPct <= 0) { ltvLoanMax = 0; }
  else { const mp = equity / (1 - ltvPct/100); ltvLoanMax = Math.floor(mp * ltvPct / 100); }

  const finalLoan = Math.min(dsrLoanMax, monthlyLoanMax, ltvLoanMax);
  const finalMonthly = Math.floor(monthlyPayment(finalLoan, rate, term));
  const maxPurchasePrice = finalLoan + equity;

  // UI
  document.getElementById('totalIncome').textContent = fmtShort(totalIncome);
  document.getElementById('totalIncomeSub').textContent = `ë³¸ì¸ ${income1.toLocaleString()} + ë°°ìš°ì ${income2.toLocaleString()}`;
  document.getElementById('equity').textContent = fmtShort(equity);
  document.getElementById('equitySub').textContent = `ì´ ${cash.toLocaleString()} - ì¸í…Œë¦¬ì–´ ${interior.toLocaleString()}`;
  document.getElementById('maxPrice').textContent = fmtShort(maxPurchasePrice);
  document.getElementById('maxPrice').style.color = maxPurchasePrice >= 30000 ? 'var(--green)' : maxPurchasePrice >= 20000 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('maxPriceSub').textContent = `ìê¸°ìê¸ˆ ${fmtShort(equity)} + ëŒ€ì¶œ ${fmtShort(finalLoan)}`;
  document.getElementById('maxPriceBar').style.width = Math.min(100, maxPurchasePrice/600*100) + '%';
  document.getElementById('monthlyLeft').textContent = monthlyRoom + 'ë§Œ';
  document.getElementById('monthlyLeft').style.color = monthlyRoom >= 150 ? 'var(--green)' : monthlyRoom >= 100 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('monthlyLeftSub').textContent = `í•œë„ ${monthlyLimit}ë§Œ - ê´€ë¦¬ë¹„ ${mgmt}ë§Œ`;
  document.getElementById('monthlyBar').style.width = Math.min(100, monthlyRoom/250*100) + '%';

  document.getElementById('ltvMax').textContent = fmtShort(ltvLoanMax);
  document.getElementById('ltvDetail').innerHTML = `LTV ${effectiveLTV}%<br><span>ìê¸°ìê¸ˆ ${fmtShort(equity)} â†’ ë§¤ë§¤ê°€ ${fmtShort(Math.floor(equity/(1-effectiveLTV/100)))}ê¹Œì§€</span>`;
  document.getElementById('ltvCard').className = 'loan-card ' + (ltvLoanMax >= finalLoan ? 'ok' : 'warn');
  document.getElementById('dsrMax').textContent = fmtShort(dsrLoanMax);
  document.getElementById('dsrDetail').innerHTML = `DSR ${dsrPct}% Â· ì—°ì†Œë“ ${fmtShort(totalIncome)}<br><span>ì›” ${Math.floor(monthlyRepayFromDSR)}ë§Œ ìƒí™˜ ê°€ëŠ¥</span>`;
  document.getElementById('dsrCard').className = 'loan-card ' + (dsrLoanMax >= finalLoan ? 'ok' : 'warn');
  document.getElementById('monthlyMax').textContent = fmtShort(monthlyLoanMax);
  document.getElementById('monthlyDetail').innerHTML = `ì›” ${monthlyRoom}ë§Œ ìƒí™˜ ê°€ëŠ¥<br><span>ê¸ˆë¦¬ ${rate}% Â· ${term}ë…„</span>`;
  document.getElementById('monthlyCard').className = 'loan-card ' + (monthlyLoanMax >= finalLoan ? 'ok' : 'warn');
  document.getElementById('finalLoan').textContent = fmtShort(finalLoan);
  document.getElementById('finalDetail').innerHTML = `ì›” ${finalMonthly}ë§Œ Â· ë§¤ìˆ˜ê°€ëŠ¥ ${fmtShort(maxPurchasePrice)}<br><span>LTVÂ·DSRÂ·ì›”ìƒí™˜ ì¤‘ ìµœì†Ÿê°’</span>`;
  let bottleneck = 'LTV';
  if (finalLoan === dsrLoanMax) bottleneck = 'DSR';
  if (finalLoan === monthlyLoanMax) bottleneck = 'ì›”ìƒí™˜';
  document.getElementById('loanBadge').textContent = `ë³‘ëª©: ${bottleneck}`;

  // --- ë§¤ë¬¼ í…Œì´ë¸” ---
  searchQuery = document.getElementById('searchInput').value.toLowerCase();
  regionFilterVal = document.getElementById('regionFilter').value;
  verdictFilterVal = document.getElementById('verdictFilter').value;

  let filtered = PROPERTIES.filter(p => {
    if (searchQuery && !`${p.name} ${p.region} ${p.dong}`.toLowerCase().includes(searchQuery)) return false;
    if (regionFilterVal && p.region !== regionFilterVal) return false;
    return true;
  });

  // Sort
  if (currentSort === 'price-asc') filtered.sort((a,b) => a.price - b.price);
  else if (currentSort === 'price-desc') filtered.sort((a,b) => b.price - a.price);
  else if (currentSort === 'walk') filtered.sort((a,b) => (a.walk_min||999) - (b.walk_min||999));

  const tbody = document.getElementById('propertyBody');
  tbody.innerHTML = '';
  let shown = 0;

  filtered.forEach(p => {
    const pLTV = p.regulated ? Math.min(effectiveLTV, 50) : effectiveLTV;
    const pLoan = Math.min(Math.floor(p.price * pLTV / 100), finalLoan);
    const pEquityNeeded = p.price - pLoan;
    const pMonthly = Math.floor(monthlyPayment(pLoan, rate, term));

    let verdict, verdictTag;
    if (pEquityNeeded > equity) { verdict = 'ìê¸ˆë¶€ì¡±'; verdictTag = 'tag-danger'; }
    else if (pMonthly > monthlyRoom) { verdict = 'ìƒí™˜ì´ˆê³¼'; verdictTag = 'tag-danger'; }
    else if (pMonthly > monthlyRoom * 0.85) { verdict = 'ë¹ ë“¯í•¨'; verdictTag = 'tag-warn'; }
    else { verdict = 'ë§¤ìˆ˜ê°€ëŠ¥'; verdictTag = 'tag-ok'; }

    if (verdictFilterVal && verdict !== verdictFilterVal) return;
    shown++;

    const extra = [];
    if (p.built_year) extra.push(`${p.built_year}ë…„`);
    if (p.households) extra.push(`${p.households}ì„¸ëŒ€`);
    if (p.trade_count > 1) extra.push(`${p.trade_count}ê±´`);

    const tradeBtn = p.trade_count > 1 ? `<button class="expand-btn" onclick="toggleHistory(this)">â–¶ ê±°ë˜ë‚´ì—­ ${p.trade_count}ê±´</button>` : '';

    // ê±°ë˜ íˆìŠ¤í† ë¦¬ HTML
    let historyHtml = '';
    if (p.trade_count > 1) {
      const rows = p.trades.map((t, i) => {
        let deltaHtml = '';
        if (i < p.trades.length - 1) {
          const diff = t.price - p.trades[i+1].price;
          if (diff > 0) deltaHtml = `<span class="trade-delta up">+${fmtShort(diff)}</span>`;
          else if (diff < 0) deltaHtml = `<span class="trade-delta down">${fmtShort(diff)}</span>`;
          else deltaHtml = `<span class="trade-delta same">Â±0</span>`;
        }
        return `<div class="trade-row">
          <span class="trade-date">${t.date || 'ë‚ ì§œì—†ìŒ'}</span>
          <span class="trade-price">${fmtShort(t.price)}</span>
          <span class="trade-floor">${t.floor}ì¸µ</span>
          ${deltaHtml}
        </div>`;
      }).join('');

      const priceDiff = p.max_price - p.min_price;
      const rangeText = priceDiff > 0 ? `ë³€ë™í­: ${fmtShort(priceDiff)}` : 'ë™ì¼ê°€';

      historyHtml = `<div class="trade-history" id="hist_${shown}">
        <div class="trade-history-title">
          <span>ğŸ“Š ê±°ë˜ íˆìŠ¤í† ë¦¬ (ìµœì‹ ìˆœ)</span>
          <span style="font-size:10px;color:var(--text-dim)">${rangeText}</span>
        </div>
        ${rows}
      </div>`;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="ë‹¨ì§€ëª…"><strong>${p.name}</strong><br><span style="font-size:10px;color:var(--text-dim)">${p.line ? p.line+' ' : ''}${p.station}${extra.length ? ' Â· '+extra.join(' Â· ') : ''}</span><br>${tradeBtn}${historyHtml}</td>
      <td data-label="ì§€ì—­"><span class="tag tag-region">${p.region}</span></td>
      <td data-label="ë©´ì ">${fmtArea(p)}</td>
      <td data-label="ë§¤ë§¤ê°€" class="mono">${fmtShort(p.price)}${p.trade_count > 1 ? '<br><span style="font-size:9px;color:var(--text-dim)">'+fmtShort(p.min_price)+'~'+fmtShort(p.max_price)+'</span>' : ''}</td>
      <td data-label="í•„ìš”ìê¸ˆ" class="mono" style="color:${pEquityNeeded > equity ? 'var(--red)' : 'var(--text)'}">${fmtShort(pEquityNeeded)}</td>
      <td data-label="ëŒ€ì¶œì•¡" class="mono">${fmtShort(pLoan)}<br><span style="font-size:10px;color:var(--text-dim)">LTV ${pLTV}%</span></td>
      <td data-label="ì›”ìƒí™˜" class="mono" style="color:${pMonthly > monthlyRoom ? 'var(--red)' : pMonthly > monthlyRoom*0.85 ? 'var(--yellow)' : 'var(--green)'}">${pMonthly}ë§Œ</td>
      <td data-label="íŒì •"><span class="tag ${verdictTag}">${verdict}</span></td>
      <td data-label="ë§í¬"><div class="link-icons">${makeLinks(p)}</div></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('propertyBadge').textContent = DATA_LOADED ? `${shown}/${PROPERTIES.length}ê°œ í‘œì‹œ` : 'ë°ì´í„° ì—†ìŒ';

  // --- ì •ì±…ëŒ€ì¶œ ---
  const policyLoans = [
    { name:'ë””ë”¤ëŒ ëŒ€ì¶œ', icon:'ğŸ ', incomeLimit:6000, desc:'ë¶€ë¶€í•©ì‚° 6,000ë§Œ ì´í•˜', maxLoan:'ìµœëŒ€ 2.5ì–µ', rate:'2.15~3.00%', conditions:['ë¬´ì£¼íƒ','ì£¼íƒê°€ê²© 5ì–µ ì´í•˜'], houseReq:0 },
    { name:'ë³´ê¸ˆìë¦¬ë¡ ', icon:'ğŸ›¡ï¸', incomeLimit:7000, desc:'ë¶€ë¶€í•©ì‚° 7,000ë§Œ ì´í•˜', maxLoan:'ìµœëŒ€ 3.6ì–µ', rate:'3.25~3.85%', conditions:['ë¬´ì£¼íƒ/1ì£¼íƒ ì²˜ë¶„','ì£¼íƒ 6ì–µ ì´í•˜'], houseReq:1 },
    { name:'ì‹ í˜¼ë¶€ë¶€ êµ¬ì…', icon:'ğŸ’', incomeLimit:8500, desc:'ë¶€ë¶€í•©ì‚° 8,500ë§Œ ì´í•˜', maxLoan:'ìµœëŒ€ 3ì–µ', rate:'1.85~2.70%', conditions:['í˜¼ì¸ 7ë…„ ì´ë‚´','ë¬´ì£¼íƒ','5ì–µ ì´í•˜'], houseReq:0 },
    { name:'ì‹ ìƒì•„ íŠ¹ë¡€', icon:'ğŸ‘¶', incomeLimit:20000, desc:'ë¶€ë¶€í•©ì‚° 2ì–µ ì´í•˜', maxLoan:'ìµœëŒ€ 5ì–µ', rate:'1.60~3.30%', conditions:['2ë…„ ë‚´ ì¶œìƒì•„','ë¬´ì£¼íƒ','9ì–µ ì´í•˜'], houseReq:0, special:'ì¶œì‚° ì‹œ í™œìš© ê°€ëŠ¥' },
    { name:'ìƒì• ìµœì´ˆ íŠ¹ë¡€', icon:'ğŸŒŸ', incomeLimit:10000, desc:'ë¶€ë¶€í•©ì‚° 1ì–µ ì´í•˜', maxLoan:'ìµœëŒ€ 4ì–µ', rate:'ì‹œì¤‘ê¸ˆë¦¬ ìš°ëŒ€', conditions:['ìƒì•  ìµœì´ˆ','ë¬´ì£¼íƒ','9ì–µ ì´í•˜'], houseReq:0 },
  ];

  const policyGrid = document.getElementById('policyGrid');
  policyGrid.innerHTML = '';
  let eligibleCount = 0;

  policyLoans.forEach(loan => {
    const gap = totalIncome - loan.incomeLimit;
    const isIncomeOk = gap <= 0, isHouseOk = houseCount <= loan.houseReq, isSpecial = !!loan.special;
    let statusClass, statusText, cardClass;
    if (isIncomeOk && isHouseOk && !isSpecial) { statusClass='yes'; statusText='âœ… ìê²© ì¶©ì¡±'; cardClass='eligible'; eligibleCount++; }
    else if (isSpecial) { statusClass='check'; statusText='â³ '+loan.special; cardClass='checking'; }
    else if (isIncomeOk && !isHouseOk) { statusClass='maybe'; statusText='â³ ë¬´ì£¼íƒ ì‹œ ê°€ëŠ¥'; cardClass='conditional'; }
    else if (!isIncomeOk && gap<=1000) { statusClass='maybe'; statusText='âš ï¸ ì†Œë“ ê·¼ì ‘'; cardClass='conditional'; }
    else { statusClass='no'; statusText='âŒ ì†Œë“ ì´ˆê³¼'; cardClass='ineligible'; }

    let gapText, gapClass;
    if (gap>0) { gapText=`${gap.toLocaleString()}ë§Œ ì´ˆê³¼`; gapClass=gap<=1000?'close':'over'; }
    else if (gap===0) { gapText='ê¸°ì¤€ ë”± ë§ìŒ'; gapClass='close'; }
    else { gapText=`${Math.abs(gap).toLocaleString()}ë§Œ ì—¬ìœ `; gapClass='under'; }

    const card = document.createElement('div');
    card.className = `policy-card ${cardClass}`;
    card.innerHTML = `
      <div class="policy-name">${loan.icon} ${loan.name} <span class="policy-status ${statusClass}">${statusText}</span></div>
      <div class="policy-detail">${loan.desc} Â· ${loan.maxLoan} Â· ${loan.rate}<br>ì¡°ê±´: ${loan.conditions.join(' / ')}</div>
      <div class="policy-gap ${gapClass}">ì†Œë“ ${gapText}</div>
    `;
    policyGrid.appendChild(card);
  });

  document.getElementById('policyBadge').textContent = eligibleCount > 0 ? `${eligibleCount}ê°œ ìê²© ì¶©ì¡±!` : 'ìë™ íŒì •';

  // ë°ì´í„° ìƒíƒœ
  const statusEl = document.getElementById('dataStatus');
  if (DATA_LOADED) { statusEl.textContent = `ğŸ“Š ${PROPERTIES.length}ê°œ ë‹¨ì§€ Â· ê°±ì‹ : ${DATA_UPDATED_AT}`; statusEl.style.color = 'var(--green)'; }
  else { statusEl.textContent = 'âš ï¸ ë°°ì¹˜ ì‹¤í–‰ í›„ ë°ì´í„° í‘œì‹œ'; statusEl.style.color = 'var(--yellow)'; }
}

// ============================================================
// ì´ë²¤íŠ¸ ì—°ê²°
// ============================================================
const PAIRS = [
  ['income1','income1Val'],['income2','income2Val'],
  ['cash','cashVal'],['interior','interiorVal'],
  ['rate','rateVal'],['term','termVal'],
  ['monthlyLimit','monthlyLimitVal'],['mgmt','mgmtVal'],
  ['ltv','ltvVal'],['dsr','dsrVal'],
];
PAIRS.forEach(([s,i]) => {
  const slider = document.getElementById(s), input = document.getElementById(i);
  slider.addEventListener('input', () => { input.value = slider.value; update(); });
  input.addEventListener('input', () => { slider.value = input.value; update(); });
});
document.getElementById('houseCount').addEventListener('change', update);
document.getElementById('searchInput').addEventListener('input', update);
document.getElementById('regionFilter').addEventListener('change', update);
document.getElementById('verdictFilter').addEventListener('change', update);

// settings â†’ data ìˆœì„œë¡œ ë¡œë”©
loadSettings().then(() => loadData());
</script>
</body>
</html>
