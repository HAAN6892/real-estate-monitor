name: ë¶€ë™ì‚° ëª¨ë‹ˆí„°ë§

on:
  schedule:
    - cron: '0 23 * * *'
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pip install requests

      - name: config.json ìƒì„±
        env:
          MY_API_KEY: ${{ secrets.API_KEY }}
          MY_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          MY_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MY_KAKAO_KEY: ${{ secrets.KAKAO_KEY }}
        run: |
          python3 << 'EOF'
          import json, os
          config = {
              "api_key": os.environ["MY_API_KEY"],
              "telegram": {
                  "bot_token": os.environ["MY_BOT_TOKEN"],
                  "chat_id": os.environ["MY_CHAT_ID"]
              },
              "kakao_key": os.environ["MY_KAKAO_KEY"],
              "filters": {
                  "min_area": 59,
                  "max_area": 84,
                  "min_price": 0,
                  "max_price": 60000,
                  "min_floor": 1,
                  "max_build_year": 9999,
                  "min_households": 200
              },
              "regions": [
                  {"name": "ì„œìš¸ ê°•ë‚¨êµ¬", "code": "11680", "sgg_name": "ì„œìš¸ ê°•ë‚¨êµ¬"},
                  {"name": "ì„œìš¸ ì„œì´ˆêµ¬", "code": "11650", "sgg_name": "ì„œìš¸ ì„œì´ˆêµ¬"},
                  {"name": "ì„œìš¸ ì†¡íŒŒêµ¬", "code": "11710", "sgg_name": "ì„œìš¸ ì†¡íŒŒêµ¬"},
                  {"name": "ì„œìš¸ ê°•ë™êµ¬", "code": "11740", "sgg_name": "ì„œìš¸ ê°•ë™êµ¬"},
                  {"name": "ê²½ê¸° ê³¼ì²œì‹œ", "code": "41290", "sgg_name": "ê²½ê¸° ê³¼ì²œì‹œ"},
                  {"name": "ê²½ê¸° ì•ˆì–‘ ë§Œì•ˆêµ¬", "code": "41171", "sgg_name": "ê²½ê¸° ì•ˆì–‘ì‹œ ë§Œì•ˆêµ¬"},
                  {"name": "ê²½ê¸° ì•ˆì–‘ ë™ì•ˆêµ¬", "code": "41173", "sgg_name": "ê²½ê¸° ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬"},
                  {"name": "ê²½ê¸° ì„±ë‚¨ ìˆ˜ì •êµ¬", "code": "41131", "sgg_name": "ê²½ê¸° ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬"},
                  {"name": "ì„±ë‚¨ ì¤‘ì›êµ¬", "code": "41133", "sgg_name": "ê²½ê¸° ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬"},
                  {"name": "ì„±ë‚¨ ë¶„ë‹¹êµ¬", "code": "41135", "sgg_name": "ê²½ê¸° ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬"},
                  {"name": "ê²½ê¸° í•˜ë‚¨ì‹œ", "code": "41450", "sgg_name": "ê²½ê¸° í•˜ë‚¨ì‹œ"},
                  {"name": "ìš©ì¸ ìˆ˜ì§€êµ¬", "code": "41465", "sgg_name": "ê²½ê¸° ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬"},
                  {"name": "ìš©ì¸ ê¸°í¥êµ¬", "code": "41463", "sgg_name": "ê²½ê¸° ìš©ì¸ì‹œ ê¸°í¥êµ¬"},
                  {"name": "ê²½ê¸° ê´‘ì£¼ì‹œ", "code": "41610", "sgg_name": "ê²½ê¸° ê´‘ì£¼ì‹œ"}
              ],
              "schedule": {
                  "run_times": ["08:00", "20:00"]
              }
          }
          with open("config.json", "w", encoding="utf-8") as f:
              json.dump(config, f, ensure_ascii=False, indent=2)
          print("config.json ìƒì„± ì™„ë£Œ")
          EOF

      - name: ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
        run: python main.py

      - name: data.json ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --cached --quiet && echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ" || (git commit -m "ğŸ“Š data.json ì—…ë°ì´íŠ¸ $(date +'%Y-%m-%d %H:%M')" && git push)
